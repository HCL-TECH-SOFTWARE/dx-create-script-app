#!/usr/bin/env node
import A from"fs";import j from"path";import F from"os";var S=class{constructor(e){this.errorCount=0;let t=j.join(F.homedir(),".dx-script-app","logs");A.existsSync(t)||A.mkdirSync(t,{recursive:!0}),this.logFile=e?j.resolve(e):j.join(t,"logger.log")}formatTimestamp(){return new Date().toISOString().replace("T"," ").split(".")[0]}formatMessage(e,t,r){let o=this.formatTimestamp(),m=process.pid,u=F.hostname(),s=t.map(i=>typeof i=="string"?i:JSON.stringify(i)).join(" ");return r?`[${o}] ${e.toUpperCase().padEnd(7)} (PID ${m} @ ${u}) ${s}`:`[${o}] ${e.toUpperCase().padEnd(7)} ${s}`}writeToFile(e){A.appendFileSync(this.logFile,e+`
`,"utf8")}log(e,...t){let r=this.formatMessage(e,t,!0),o=this.formatMessage(e,t,!1);this.writeToFile(r),e!=="debug"&&console.log(o)}logSavingInfo(){this.errorCount>0&&this.info(`Full logs can be found at: ${this.logFile}`)}info(...e){this.log("info",...e)}success(...e){this.log("success",...e)}error(...e){this.errorCount++,this.log("error",...e)}debug(...e){this.log("debug",...e)}};import{Command as E}from"commander";var x=class{constructor(){this.program=new E}parse(e){this.program.name("create-dx-scriptapp").description("Create a new DX script app").argument("[scriptAppName]","Name of the project").option("-t, --template <template>","Template to use").option("-p, --path <path>","Path to create the project").parse(e);let t=this.program.opts();return{scriptAppName:this.program.args[0],options:t}}};import _ from"prompts";var T=class{constructor(e){this.logger=e}validateScriptAppName(e){return e?/^[a-zA-Z0-9_-]+$/.test(e)?!0:"Name must only contain letters, numbers, underscores, or hyphens (no spaces or special characters).":"Script App name is required"}async askForScriptAppName(){let t=(await _({type:"text",name:"scriptAppName",message:"Enter the script app name:",validate:this.validateScriptAppName})).scriptAppName,r=!0;return t?(typeof t!="string"||t.trim().length===0)&&(r=!1):r=!1,r||(this.logger.error("Project name is required."),process.exit(1)),t}async askForTemplate(e){return(await _({type:"select",name:"frameworkTemplate",message:"Select a framework template:",choices:e.map(r=>({title:r,value:r}))})).frameworkTemplate}};import D from"fs";import w from"path";import{fileURLToPath as L}from"url";var b=class{constructor(e){this.importMetaUrl=e;let t=w.dirname(L(this.importMetaUrl));this.templatesDir=w.join(t,"../templates")}getTemplatesDir(){return this.templatesDir}getAvailableTemplates(){return D.readdirSync(this.templatesDir).filter(e=>D.statSync(w.join(this.templatesDir,e)).isDirectory())}getTemplatePath(e){return w.join(this.templatesDir,e)}};import a from"fs";import d from"path";var N=class{constructor(e){this.logger=e}directoryExists(e){return a.existsSync(e)}createDirectory(e){a.existsSync(e)||(a.mkdirSync(e,{recursive:!0}),this.logger.info(`Created directory: ${e}`))}copyRecursive(e,t){if(a.statSync(e).isDirectory()){a.existsSync(t)||a.mkdirSync(t);for(let r of a.readdirSync(e))this.copyRecursive(d.join(e,r),d.join(t,r))}else a.copyFileSync(e,t)}formatProjectName(e){return e.trim().toLowerCase().replace(/\s+/g,"-")}resolvePath(e){return d.resolve(e)}updateTemplatePlaceholders(e,t,r){let o=[{placeholder:"__SCRIPT_APP_NAME__",value:t},{placeholder:"__CONTENT_ROOT__",value:"./dist"},{placeholder:"__WCM_CONTENT_NAME__",value:t},...r||[]],m=i=>[".js",".ts",".jsx",".tsx",".json",".html",".css",".md",".txt",".env",".local"].includes(d.extname(i)),u=i=>{if(!m(i))return;let g=!1,l=a.readFileSync(i,"utf-8");if(d.basename(i)==="package.json"){let p=JSON.parse(l);if(p.scripts&&p.scripts["dx-deploy"]){let c=p.scripts["dx-deploy"];for(let{placeholder:h,value:f}of o)c.includes(h)&&(c=c.replace(new RegExp(h.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),f));c!==p.scripts["dx-deploy"]&&(p.scripts["dx-deploy"]=c,g=!0)}let v=c=>{for(let h in c){let f=c[h];if(typeof f=="string"){let y=f,k=!1;for(let{placeholder:$,value:C}of o)y.includes($)&&(y=y.replace(new RegExp($.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),C),k=!0);k&&(c[h]=y,g=!0)}else typeof f=="object"&&f!==null&&v(f)}};v(p),g&&(a.writeFileSync(i,JSON.stringify(p,null,2)),this.logger.info(`Updated placeholders in: ${i}`))}else{let p=!1;for(let{placeholder:v,value:c}of o)l.includes(v)&&(l=l.replace(new RegExp(v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),c),p=!0);p&&(a.writeFileSync(i,l,"utf-8"),this.logger.info(`Updated placeholders in: ${i}`))}},s=i=>{for(let g of a.readdirSync(i)){if(g==="node_modules")continue;let l=d.join(i,g),p=a.statSync(l);p.isDirectory()?s(l):p.isFile()&&u(l)}};s(e)}};var P=class{constructor(e,t,r,o){this.logger=e;this.promptService=t;this.templateService=r;this.fileService=o}async createScriptApp(e,t){let r=e||await this.promptService.askForScriptAppName(),o=this.templateService.getAvailableTemplates(),m=t;(!m||!o.includes(m))&&(m=await this.promptService.askForTemplate(o));let u=this.fileService.formatProjectName(r),s=this.fileService.resolvePath(`./${u}`);this.fileService.directoryExists(s)&&(this.logger.error(`Directory already exists: ${s}`),process.exit(1)),this.fileService.createDirectory(s);let i=this.templateService.getTemplatePath(m);this.fileService.copyRecursive(i,s),this.logger.info(`Scaffolding project in ${s}`);let g=Date.now(),l=`${r.toLowerCase().replace(/\s+/g,"-")}-${g}`;this.fileService.updateTemplatePlaceholders(s,r,[{placeholder:"__ROOT_IDENTIFIER__",value:l}]),this.logger.info(`Done. Now run:

			# Go to the generated directory
			cd ${s}
      
      
			# To deploy the script locally run
			npm install
			npm run dev
			

			# To deploy script app, make sure to check Environment (.env files) and update the credentials accordingly
			# And run:
			npm install
			npm run build
			npm run dx-deploy
		`),this.logger.logSavingInfo()}};(async()=>{try{let n=new S,e=new x,t=new T(n),r=new b(import.meta.url),o=new N(n),m=new P(n,t,r,o),{scriptAppName:u,options:s}=e.parse(process.argv);await m.createScriptApp(u,s.template)}catch(n){new S().error(`An unexpected error occurred: ${n instanceof Error?n.message:String(n)}`),process.exit(1)}})();
